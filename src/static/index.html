<!doctype html>
<html data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <title>CPQ</title>
    <style>
      * { box-sizing: border-box; }
      :root {
        --bg: #f6f7fb;
        --surface: #ffffff;
        --text: #0f172a;
        --muted: #6b7280;
        --border: #e5e7eb;
        --accent: #2563eb;
        --accent-600: #1d4ed8;
        --accent-700: #1e40af;
        --table-header: #f1f5f9;
        --shadow-sm: 0 1px 2px rgba(16,24,40,.06);
        --shadow-md: 0 6px 14px rgba(16,24,40,.08);
        --prompt-text: #000000; /* black for prompt/result text */
      }
      [data-theme="dark"] {
        --bg: #0b1220;
        --surface: #0f172a;
        --text: #e5e7eb;
        --muted: #97a3b6;
        --border: #1f2937;
        --accent: #22d3ee; /* cyan accent in dark */
        --accent-600: #06b6d4;
        --accent-700: #0891b2;
        --table-header: #0b1220;
        --prompt-text: #000000; /* force black as requested */
      }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      }
      .container { max-width: 1120px; margin: 0 auto; padding: 24px; }
      .topbar { position: sticky; top: 0; z-index: 10; background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); }
      .topbar .inner { max-width: 1120px; margin: 0 auto; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
      .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; }
      .brand .dot { width: 10px; height: 10px; border-radius: 999px; background: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
      .top-actions { display: flex; align-items: center; gap: 10px; }
      .icon-btn { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--text); cursor: pointer; box-shadow: var(--shadow-sm); }
      .icon-btn:hover { background: rgba(0,0,0,.03); }
      .icon-btn:active { transform: translateY(1px); }
      .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
      .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
      .tab { padding: 10px 12px; border: 1px solid transparent; border-top-left-radius: 8px; border-top-right-radius: 8px; color: var(--muted); text-decoration: none; }
      .tab.active { color: var(--text); background: var(--surface); border-color: var(--border) var(--border) #fff; }
      .title { font-size: 22px; font-weight: 700; letter-spacing: .2px; }
      .subtitle { color: var(--muted); font-size: 13px; }
      .two-col { display: grid; grid-template-columns: 1fr; gap: 24px; }
      @media (min-width: 960px) { .two-col { grid-template-columns: 1.4fr .8fr; } }
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 18px;
        box-shadow: var(--shadow-md);
      }
      .sticky { position: sticky; top: 16px; }
      .card h2 { margin: 0 0 12px; font-size: 16px; }
      label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
      textarea, input[type="file"] {
        width: 100%;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        color: var(--prompt-text);
      }
      /* Make the file input align and size like other controls */
      input[type="file"] { height: 40px; padding: 6px 10px; }
      /* Modern browsers */
      input[type="file"]::file-selector-button {
        border: none;
        background: var(--accent);
        color: #fff;
        border-radius: 6px;
        padding: 8px 12px;
        margin-right: 12px;
        cursor: pointer;
      }
      /* Safari/WebKit */
      input[type="file"]::-webkit-file-upload-button {
        border: none;
        background: var(--accent);
        color: #fff;
        border-radius: 6px;
        padding: 8px 12px;
        margin-right: 12px;
        cursor: pointer;
      }
      textarea { 
        width: 100%; height: 140px; resize: vertical; background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; font-size: 14px; color: var(--prompt-text); font-weight: 600;
      }
      .row { margin-bottom: 14px; }
      .actions { display: flex; gap: 10px; }
      button {
        appearance: none;
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #fff;
        border-radius: 8px;
        padding: 10px 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background .15s ease, border-color .15s ease;
      }
      button:hover { background: var(--accent-600); border-color: var(--accent-600); }
      button:active { background: var(--accent-700); border-color: var(--accent-700); }
      pre {
        background: #fafafa;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        font-size: 12px;
        line-height: 1.45;
        max-height: 280px;
        overflow: auto;
        width: 100%;
      }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
      th, td { border: 1px solid var(--border); padding: 8px 10px; }
      thead th { background: var(--table-header); text-align: left; }
      tbody tr:nth-child(even) { background: #fcfcfd; }

      /* Dropzone */
      .dropzone { border: 2px dashed var(--border); border-radius: 12px; padding: 18px; text-align: center; color: var(--muted); transition: border-color .15s ease, background .15s ease; }
      .dropzone.drag { border-color: var(--accent); background: rgba(37,99,235,.06); }

      /* Skeletons */
      .skeleton { position: relative; overflow: hidden; background: linear-gradient(90deg, rgba(0,0,0,0.06), rgba(0,0,0,0.12), rgba(0,0,0,0.06)); background-size: 400% 100%; animation: shimmer 1.2s ease-in-out infinite; border-radius: 8px; }
      @keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

      /* Error banner */
      .alert { padding: 10px 12px; border: 1px solid #ef4444; background: #fee2e2; color: #991b1b; border-radius: 8px; display: none; }

      /* Footer */
      .footer { margin-top: 28px; padding: 18px 0; border-top: 1px solid var(--border); color: var(--muted); font-size: 12px; text-align: center; }

      /* Chat bubbles for result */
      .chat { display: flex; flex-direction: column; gap: 8px; }
      .bubble {
        max-width: 80%; padding: 10px 12px; border-radius: 14px; box-shadow: var(--shadow-sm); font-weight: 400;
      }
      .bubble.user { margin-left: auto; background: #e0e7ff; color: #1e1b4b; }
      .bubble.bot { margin-right: auto; background: #f1f5f9; color: var(--prompt-text); }
      .thinking { width: 36px; height: 12px; display: inline-flex; align-items: center; justify-content: space-between; }
      .thinking span { width: 6px; height: 6px; background: var(--muted); border-radius: 999px; display: inline-block; animation: bounce 1.2s infinite ease-in-out; }
      .thinking span:nth-child(2){ animation-delay: .15s; }
      .thinking span:nth-child(3){ animation-delay: .3s; }
      @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); opacity: .5 } 40% { transform: translateY(-6px); opacity: 1 } }

      /* Toasts */
      .toasts { position: fixed; right: 16px; top: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
      .toast { background: var(--surface); color: var(--text); border: 1px solid var(--border); box-shadow: var(--shadow-md); border-radius: 10px; padding: 10px 12px; min-width: 220px; }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="inner">
        <div class="brand"><span class="dot"></span> <span>CPQ Platform</span></div>
        <div class="top-actions">
          <button class="icon-btn" id="themeBtn" title="Toggle theme">üåì</button>
          <button class="icon-btn" id="helpBtn" title="Help">‚ùì</button>
        </div>
      </div>
    </div>
    <div class="container">
      <nav class="tabs">
        <a class="tab" href="/agent">Home</a>
        <a class="tab active" href="/">CPQ</a>
        <a class="tab" href="/rfps">RFP's</a>
        <a class="tab" href="/orders">Orders</a>
        <a class="tab" href="/logs">Logs</a>
      </nav>

      <div id="alert" class="alert"></div>

      <div class="two-col">
        <div class="card">
          <h2>Upload and Ingest</h2>
          <form id="uploadForm">
            <div class="row">
              <label for="file">Select PDF or DOCX</label>
              <div id="dropzone" class="dropzone">Drag & drop file here, or click to browse</div>
              <input style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" type="file" id="file" accept=".pdf,.docx" />
            </div>
            <div class="row actions">
              <button id="uploadBtn" type="button">Upload & Ingest</button>
              <button id="openPdf" type="button" style="display:none">Open PDF Preview</button>
            </div>
          </form>
          <h3 style="margin-top:14px">Ingest Result</h3>
          <div id="tableWrap" style="color: var(--prompt-text)"></div>
          <pre id="ingestResult" style="color: var(--prompt-text)">(no result yet)</pre>
          <div id="pricingLink" style="margin-top:8px"></div>
        </div>

        <div class="card sticky">
          <h2>Run Agent</h2>
          <div class="row">
            <label for="prompt">Prompt</label>
            <textarea id="prompt">Say hello and list the available MCP tools.</textarea>
          </div>
          <div class="row actions">
            <button id="run">Run Agent</button>
          </div>
          <h3 style="margin-top:14px">Result</h3>
          <div id="chat" class="chat">
            <div class="bubble bot">(no result yet)</div>
          </div>
        </div>
      </div>
      <div class="footer">¬© 2025 CPQ Platform</div>
    </div>
    <div class="toasts" id="toasts"></div>
    <script>
      const runBtn = document.getElementById('run');
      const promptEl = document.getElementById('prompt');
      const chatEl = document.getElementById('chat');
      const uploadForm = document.getElementById('uploadForm');
      const uploadBtn = document.getElementById('uploadBtn');
      // Ensure clicking the Upload button opens the picker if no file is chosen yet
      uploadBtn.addEventListener('click', () => {
        if (!fileEl.files || !fileEl.files.length) {
          fileEl.click();
        } else {
          uploadForm.requestSubmit();
        }
      });
      const fileEl = document.getElementById('file');
      const ingestResultEl = document.getElementById('ingestResult');
      const tableWrap = document.getElementById('tableWrap');
      const openPdfBtn = document.getElementById('openPdf');
      const dropzone = document.getElementById('dropzone');
      const alertEl = document.getElementById('alert');
      const toasts = document.getElementById('toasts');
      const themeBtn = document.getElementById('themeBtn');

      // Theme toggle
      themeBtn.onclick = ()=>{
        const d = document.documentElement;
        d.setAttribute('data-theme', d.getAttribute('data-theme')==='dark' ? 'light' : 'dark');
        showToast('Theme updated');
      };

      function showToast(msg){
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        toasts.appendChild(t);
        setTimeout(()=>{ t.remove(); }, 2400);
      }
      // Auto-submit after file selection
      fileEl.addEventListener('change', () => {
        if (fileEl.files && fileEl.files.length) {
          uploadForm.requestSubmit();
        }
      });

      function safeParseJSON(str){
        if (typeof str !== 'string') return null;
        try { return JSON.parse(str); } catch { return null; }
      }
      function toHumanReadable(data){
        let payload = data;
        if (payload && Object.prototype.hasOwnProperty.call(payload, 'result')){
          const inner = typeof payload.result === 'string' ? (safeParseJSON(payload.result) || payload.result) : payload.result;
          payload = inner;
        }
        if (typeof payload === 'string') return payload;
        if (payload && typeof payload === 'object'){
          const lines = [];
          const updated = Array.isArray(payload.updated_ids) ? payload.updated_ids : [];
          const createdId = payload.created_id || (payload.order && payload.order.id);
          if (updated.length) lines.push(`Updated ${updated.length} order(s): ${updated.join(', ')}.`);
          if (createdId) lines.push(`Created order ${createdId}.`);
          if (Array.isArray(payload.orders) && payload.orders.length){
            const list = payload.orders.map(o=>`${o.id} ($${Number(o.subtotal||0).toFixed(2)}; ${o.status||'n/a'})`).join('; ');
            lines.push(`Selected orders: ${list}.`);
          }
          if (payload.notes) lines.push(String(payload.notes).endsWith('.') ? payload.notes : payload.notes + '.');
          if (payload.message && !lines.length) lines.push(String(payload.message));
          return lines.length ? lines.join(' ') : JSON.stringify(data, null, 2);
        }
        return JSON.stringify(data, null, 2);
      }

      runBtn.addEventListener('click', async () => {
        // Chat bubbles
        chatEl.innerHTML = '';
        const user = document.createElement('div'); user.className='bubble user'; user.textContent = promptEl.value; chatEl.appendChild(user);
        const bot = document.createElement('div'); bot.className='bubble bot'; bot.innerHTML = '<span class="thinking"><span></span><span></span><span></span></span>'; chatEl.appendChild(bot);
        try {
          const res = await fetch('/agent/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: promptEl.value })
          });
          const data = await res.json();
          bot.textContent = toHumanReadable(data);
          showToast('Agent completed');
        } catch (e) {
          bot.textContent = 'Error: ' + e;
          alertEl.textContent = 'Agent error: ' + e; alertEl.style.display='block';
        }
      });

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        ingestResultEl.textContent = 'Uploading...';
        try {
          const fd = new FormData();
          if (!fileEl.files.length) {
            // Prompt user to pick a file if none selected yet
            ingestResultEl.textContent = 'Please select a file';
            showToast('Select a .pdf or .docx to upload');
            fileEl.click();
            return;
          }
          fd.append('file', fileEl.files[0]);
          const res = await fetch('/agent/upload', {
            method: 'POST',
            body: fd
          });
          const data = await res.json();
          ingestResultEl.textContent = JSON.stringify(data, null, 2);
          if (data && data.order && data.order.id && data.pricing_url){
            document.getElementById('pricingLink').innerHTML = `<a href="${data.pricing_url}">Go to Pricing for Order ${data.order.id}</a>`;
          } else {
            document.getElementById('pricingLink').innerHTML = '';
          }
          if (data && Array.isArray(data.items) && data.items.length) {
            const tbl = document.createElement('table');
            tbl.border = '1';
            tbl.cellPadding = '6';
            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th>Item</th><th>Quantity</th><th>Unit Cost</th><th>Line Total</th></tr>';
            tbl.appendChild(thead);
            const tbody = document.createElement('tbody');
            for (const it of data.items) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${(it.item||'')}</td>
                <td style="text-align:right">${Number(it.quantity||0)}</td>
                <td style="text-align:right">$${Number(it.unit_cost||0).toFixed(2)}</td>
                <td style="text-align:right">$${Number(it.line_total||0).toFixed(2)}</td>
              `;
              tbody.appendChild(tr);
            }
            const trSub = document.createElement('tr');
            trSub.innerHTML = `
              <td colspan="3" style="text-align:right;font-weight:bold">Subtotal</td>
              <td style="text-align:right;font-weight:bold">$${Number(data.subtotal||0).toFixed(2)}</td>
            `;
            tbody.appendChild(trSub);
            tbl.appendChild(tbody);
            tableWrap.innerHTML = '';
            tableWrap.appendChild(tbl);

            openPdfBtn.style.display = 'inline-block';
            openPdfBtn.onclick = async () => {
              const pdfRes = await fetch('/agent/quote_pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: data.items, subtotal: data.subtotal })
              });
              const blob = await pdfRes.blob();
              const url = URL.createObjectURL(blob);
              window.open(url, '_blank');
            };
            showToast('Upload processed');
          } else {
            tableWrap.innerHTML = '';
            openPdfBtn.style.display = 'none';
          }
        } catch (e) {
          ingestResultEl.textContent = 'Error: ' + e;
          alertEl.textContent = 'Upload error: ' + e; alertEl.style.display='block';
        }
      });

      // Dropzone behavior
      dropzone.addEventListener('click', ()=> fileEl.click());
      dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.classList.add('drag'); });
      dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('drag'));
      dropzone.addEventListener('drop', (e)=>{
        e.preventDefault(); dropzone.classList.remove('drag');
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) { fileEl.files = e.dataTransfer.files; showToast('File attached'); }
      });
    </script>
  </body>
  </html>



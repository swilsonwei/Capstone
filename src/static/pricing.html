<!doctype html>
<html data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <title>Pricing</title>
    <style>
      * { box-sizing: border-box; }
      :root { --bg:#f6f7fb; --surface:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; --accent-600:#1d4ed8; --accent-700:#1e40af; --table-header:#f1f5f9; --shadow-sm:0 1px 2px rgba(16,24,40,.06); --shadow-md:0 6px 14px rgba(16,24,40,.08); --prompt-text:#000000 }
      [data-theme="dark"] { --bg:#0b1220; --surface:#0f172a; --text:#e5e7eb; --muted:#97a3b6; --border:#1f2937; --accent:#22d3ee; --accent-600:#06b6d4; --accent-700:#0891b2; --table-header:#0b1220; --prompt-text:#000000 }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); margin:0; }
      .topbar { position: sticky; top: 0; z-index: 10; background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); }
      .topbar .inner { max-width: 1120px; margin: 0 auto; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
      .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px }
      .brand .dot { width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.15) }
      .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text); cursor:pointer; box-shadow:var(--shadow-sm) }
      .icon-btn:hover { background:rgba(0,0,0,.03) }
      .container{ max-width: 1120px; margin:0 auto; padding:24px; }
      .breadcrumbs { margin-bottom: 12px; }
      a { color:#2563eb; text-decoration:none; }
      .card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px; box-shadow: var(--shadow-md) }
      /* Meta subheader styling */
      .meta { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:6px 0 12px; }
      .badge { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--surface); color:var(--text); box-shadow: var(--shadow-sm); }
      .badge .label { color:var(--muted); font-size:12px; }
      .badge .value { font-size:14px; font-weight:700; }
      .badge.accent { border-color: var(--accent); background: rgba(37,99,235,.08); }
      table { width:100%; border-collapse:collapse; font-size:14px; }
      th, td { border:1px solid var(--border); padding:8px 10px; }
      thead th { background:var(--table-header); text-align:left; }
      input[type="text"], input[type="number"] { 
        width:100%; padding:6px 8px; border:1px solid var(--border); border-radius:6px; color:var(--prompt-text); font-weight: 600;
      }
      .actions { display:flex; gap:10px; margin-top:12px; }
      button { padding:10px 14px; border-radius:8px; border:1px solid var(--accent); background:var(--accent); color:#fff; cursor:pointer; }
      button.secondary { background:#fff; color:var(--accent); }
      button:disabled { background:#9ca3af; border-color:#9ca3af; cursor:not-allowed; }
      .toasts { position: fixed; right: 16px; top: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
      .toast { background: var(--surface); color: var(--text); border: 1px solid var(--border); box-shadow: var(--shadow-md); border-radius: 10px; padding: 10px 12px; min-width: 220px; }
      .footer { margin-top: 28px; padding: 18px 0; border-top: 1px solid var(--border); color: var(--muted); font-size: 12px; text-align: center; }
      /* Agent chat UI (match CPQ/Orders) */
      .chat { display:flex; flex-direction:column; gap:8px; }
      .chat-scroll { max-height:340px; overflow:auto; }
      .bubble { max-width:80%; padding:10px 12px; border-radius:14px; box-shadow: var(--shadow-sm); font-weight:400; }
      .bubble.user { margin-left:auto; background:#e0e7ff; color:#1e1b4b; }
      .bubble.bot { margin-right:auto; background:#f1f5f9; color: var(--prompt-text); }
      .thinking { width:36px; height:12px; display:inline-flex; align-items:center; justify-content:space-between; }
      .thinking span { width:6px; height:6px; background: var(--muted); border-radius:999px; display:inline-block; animation: bounce 1.2s infinite ease-in-out; }
      .thinking span:nth-child(2){ animation-delay:.15s; }
      .thinking span:nth-child(3){ animation-delay:.3s; }
      @keyframes bounce { 0%,80%,100% { transform: translateY(0); opacity:.5 } 40% { transform: translateY(-6px); opacity:1 } }
    </style>
  </head>
  <body>
    <!-- Clerk temporarily disabled -->
    <div class="topbar">
      <div class="inner">
        <div class="brand"><span class="dot"></span> <span>Wilson App</span></div>
        <div class="top-actions"></div>
      </div>
    </div>
    <div class="container">
      <div class="breadcrumbs">
        <a href="/cpq">← Back to CPQ</a> &nbsp;|&nbsp; <a href="/orders">Orders</a>
      </div>
      <div class="card">
        <h2>Pricing</h2>
        <div id="meta"></div>
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:50%">Item</th>
              <th style="width:12%">Quantity</th>
              <th style="width:18%">Unit Cost</th>
              <th style="width:20%">Line Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="actions">
          <button id="edit" class="secondary">Edit</button>
          <button id="save" style="display:none">Save</button>
          <button id="cancel" class="secondary" style="display:none">Cancel</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Run Agent</h2>
        <div id="chat" class="chat chat-scroll" style="font-size:16px;color:var(--prompt-text);font-weight:400;font-family:inherit"></div>
        <div class="row" style="margin-top:12px">
          <label for="agentPrompt">Prompt</label>
          <textarea id="agentPrompt" style="width:100%;height:120px">Say hello!</textarea>
        </div>
        <div class="actions">
          <button id="runAgent">Run Agent</button>
        </div>
      </div>
      <div class="footer">© 2025 Wilson App</div>
    </div>
    <div class="toasts" id="toasts"></div>
    <script>
      const orderId = location.pathname.split('/').pop();
      const tbody = document.querySelector('#tbl tbody');
      const meta = document.getElementById('meta');
      let original = null;
      let isEditing = false;

      async function authHeaders(){ return {}; }

      function showToast(msg){
        const toasts = document.getElementById('toasts');
        if (!toasts) return;
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        toasts.appendChild(t);
        setTimeout(()=>{ t.remove(); }, 2200);
      }

      function formatMoneyNoDecimals(n){
        const val = Number(n||0);
        return `$${val.toLocaleString('en-US', { maximumFractionDigits: 0, minimumFractionDigits: 0 })}`;
      }

      function row(item){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" value="${item.item||''}" /></td>
          <td><input type="number" step="0.01" value="${Number(item.quantity||0)}" /></td>
          <td><input type="number" step="0.01" value="${Number(item.unit_cost||0)}" /></td>
          <td class="total">${formatMoneyNoDecimals(item.line_total||0)}</td>
        `;
        const [iName, iQty, iCost] = tr.querySelectorAll('input');
        function recalc(){
          const qty = parseFloat(iQty.value||'0')||0;
          const cost = parseFloat(iCost.value||'0')||0;
          tr.querySelector('.total').textContent = formatMoneyNoDecimals(qty*cost);
        }
        iQty.addEventListener('input', recalc);
        iCost.addEventListener('input', recalc);
        return tr;
      }

      async function load(){
        const headers = await authHeaders();
        const res = await fetch(`/pricing/data/${orderId}`, { headers });
        const data = await res.json();
        let o = data.order;
        // If items are missing but items_count suggests otherwise, proactively request backend to rehydrate
        if ((!o.items || !o.items.length) && Number(o.items_count||0) > 0){
          try {
            // Trigger server-side reconciliation by hitting pricing_data again
            const res2 = await fetch(`/pricing/data/${orderId}`, { headers });
            const data2 = await res2.json();
            if (data2 && data2.order) o = data2.order;
          } catch {}
        }
        original = JSON.parse(JSON.stringify(o));
        meta.innerHTML = `
          <div class="meta">
            <span class="badge"><span class="label">Order</span><span class="value">${o.id||''}</span></span>
            <span class="badge"><span class="label">Customer</span><span class="value">${o.customer||''}</span></span>
            <span class="badge"><span class="label">Source</span><span class="value">${o.source_file||''}</span></span>
            <span class="badge accent"><span class="label">Subtotal</span><span class="value">${formatMoneyNoDecimals(o.subtotal||0)}</span></span>
          </div>
        `;
        tbody.innerHTML='';
        for(const it of (o.items||[])) tbody.appendChild(row(it));
        // Guardrail: Sent/Received orders are read-only
        const readOnly = String(o.status||'') === 'Sent' || String(o.status||'') === 'Received';
        setEditMode(!readOnly);
        if (readOnly) {
          const saveBtn = document.getElementById('save');
          const cancelBtn = document.getElementById('cancel');
          const editBtn = document.getElementById('edit');
          if (saveBtn) saveBtn.style.display = 'none';
          if (cancelBtn) cancelBtn.style.display = 'none';
          if (editBtn) editBtn.style.display = 'none';
          const notice = document.createElement('div');
          notice.className = 'subtitle';
          notice.textContent = 'This order is read-only while in Sent or Received status.';
          document.querySelector('.card').insertBefore(notice, document.getElementById('tbl'));
        }
        // Allow inline update of customer via agent-style command if needed
      }

      function setEditMode(edit){
        isEditing = !!edit;
        const saveBtn = document.getElementById('save');
        const cancelBtn = document.getElementById('cancel');
        const editBtn = document.getElementById('edit');
        if (isEditing){
          saveBtn.style.display = '';
          cancelBtn.style.display = '';
          editBtn.style.display = 'none';
        } else {
          saveBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
          editBtn.style.display = '';
        }
        for (const inp of tbody.querySelectorAll('input')){ inp.disabled = !isEditing; }
      }
      function setSaving(isSaving){
        try{
          const saveBtn = document.getElementById('save');
          const cancelBtn = document.getElementById('cancel');
          saveBtn.disabled = !!isSaving;
          cancelBtn.disabled = !!isSaving;
          if (isSaving){
            saveBtn.dataset._label = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
          } else {
            saveBtn.textContent = saveBtn.dataset._label || 'Save';
          }
        } catch {}
      }

      document.getElementById('edit').onclick = ()=>{ setEditMode(true); };
      document.getElementById('cancel').onclick = async ()=>{ await load(); setEditMode(false); };
      document.getElementById('save').onclick = async ()=>{
        const items=[];
        for(const tr of tbody.querySelectorAll('tr')){
          const [iName, iQty, iCost] = tr.querySelectorAll('input');
          items.push({ item:iName.value, quantity: parseFloat(iQty.value||'0')||0, unit_cost: parseFloat(iCost.value||'0')||0 });
        }
        const headers = Object.assign({'Content-Type':'application/json'}, await authHeaders());
        setSaving(true);
        try{
          const res = await fetch(`/pricing/save/${orderId}`, { method:'POST', headers, body: JSON.stringify({ items }) });
          const data = await res.json();
          if(data && data.ok){
            await load();
            setEditMode(false);
            showToast('Saved');
            // Redirect to Orders page after successful save
            window.location.href = '/orders';
            return;
          } else {
            showToast('Save failed');
          }
        } finally {
          setSaving(false);
        }
      };

      load();
    </script>
    <script>
      function safeParseJSON(str){ if (typeof str !== 'string') return null; try { return JSON.parse(str); } catch { return null; } }
      function sanitizeAgentText(text){
        try{
          let s = String(text || '');
          s = s.replace(/\n?\s*-\s*\*\*[^*]+\*\*:\s*.*(?=\n|$)/g, '');
          s = s.replace(/```[\s\S]*?```/g, '');
          s = s.replace(/^[\t ]*[\[{].*$/gm, '');
          // Strip markdown headings like #, ##, ### while keeping their content
          s = s.replace(/^[\t ]{0,3}#{1,6}[^\S\r\n]*(.*)$/gm, '$1');
          // Remove generic bullets and numbered list lines
          s = s.replace(/^\s*(?:[-*]|\d+[.)])\s.*$/gm, '');
          // If bullets follow, keep only lead sentence
          s = s.split(/\n-\s\*\*/)[0];
          // Remove residual bold wrappers
          s = s.replace(/\*\*(.*?)\*\*/g, '$1');
          s = s.replace(/\n{2,}/g, '\n').trim();
          // Prefer a concise complete statement without empty labels
          s = s.replace(/\b(?:current\s+order\s+summary|remaining\s+items)\s*:\s*/gi, '').trim();
          // Keep only the first sentence for brevity
          const sentence = s.match(/^.*?[.!?](?:\s|$)/);
          if (sentence && sentence[0]) s = sentence[0].trim();
          return s || String(text || '');
        }catch{return String(text||'');}
      }
      function rememberAssistantMessage(msg){
        try{ fetch('/logs/emit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type:'assistant_message', details:{ message: msg } }) }); }catch{}
      }
      function toHumanReadable(data){
        let payload = data;
        if (payload && Object.prototype.hasOwnProperty.call(payload, 'result')){
          const inner = typeof payload.result === 'string' ? (safeParseJSON(payload.result) || payload.result) : payload.result;
          payload = inner;
        }
        if (typeof payload === 'string') return sanitizeAgentText(payload);
        if (payload && typeof payload === 'object'){
          const lines = [];
          const updated = Array.isArray(payload.updated_ids) ? payload.updated_ids : [];
          const createdId = payload.created_id || (payload.order && payload.order.id);
          if (updated.length) lines.push(`Updated ${updated.length} order(s).`);
          if (createdId) lines.push(`Created order.`);
          if (Array.isArray(payload.orders) && payload.orders.length){
            lines.push(`Selected ${payload.orders.length} order(s).`);
          }
          if (payload.notes) lines.push(String(payload.notes).endsWith('.') ? payload.notes : payload.notes + '.');
          if (payload.message && !lines.length) lines.push(String(payload.message));
          return lines.length ? lines.join(' ') : 'Done.';
        }
        return 'Done.';
      }
      const runAgentBtn = document.getElementById('runAgent');
      const agentPromptEl = document.getElementById('agentPrompt');
      const chatEl = document.getElementById('chat');
      let history = [];
      function extractAgentResult(payload){
        try{
          if (payload && Object.prototype.hasOwnProperty.call(payload, 'result')){
            return typeof payload.result === 'string' ? (safeParseJSON(payload.result) || {}) : (payload.result || {});
          }
          return payload || {};
        }catch{ return {}; }
      }
      function didMutateCurrentOrder(payload){
        try{
          // If the agent returned a plain string, or a string in result, inspect it directly
          const lowerOrder = String(orderId || '').toLowerCase();
          if (payload && typeof payload === 'string'){
            const s = payload.toLowerCase();
            if (s.includes(lowerOrder) && /(add|added|update|updated|clone|created|variant|status)/i.test(s)) return true;
          }
          if (payload && typeof payload.result === 'string'){
            const s = String(payload.result || '').toLowerCase();
            if (s.includes(lowerOrder) && /(add|added|update|updated|clone|created|variant|status)/i.test(s)) return true;
          }
          const r = extractAgentResult(payload);
          if (!r) return false;
          if (r.order && r.order.id === orderId) return true;
          if (Array.isArray(r.updated_ids) && r.updated_ids.includes(orderId)) return true;
          if (r.updated && r.updated.id === orderId) return true;
          // Heuristic: an action list or message indicating add/update/clone/status for this order
          const blob = JSON.stringify(r);
          if (/\b(add|added|update|updated|clone|created|variant|status)\b/i.test(blob) && (blob.includes(orderId))) return true;
          return false;
        }catch{ return false; }
      }
      runAgentBtn.addEventListener('click', async () => {
        const text = agentPromptEl.value;
        const user = document.createElement('div'); user.className='bubble user'; user.textContent = text; chatEl.appendChild(user);
        history.push({ role: 'user', content: text });
        agentPromptEl.value = '';
        const bot = document.createElement('div'); bot.className='bubble bot'; bot.innerHTML = '<span class="thinking"><span></span><span></span><span></span></span>'; chatEl.appendChild(bot);
        // Busy state
        const prevLabel = runAgentBtn.textContent;
        runAgentBtn.disabled = true;
        runAgentBtn.textContent = 'Running...';
        try {
          const headers = Object.assign({'Content-Type':'application/json'}, await authHeaders());
          const res = await fetch('/agent/run', { method:'POST', headers, body: JSON.stringify({ prompt: text, history, order_id: orderId }) });
          const data = await res.json();
          const msg = toHumanReadable(data);
          const lower = String(msg||'').toLowerCase();
          const looksYN = /\bproceed\b|\byes or no\b|\bconfirm\b/.test(lower);
          if (looksYN){
            const wrap = document.createElement('div');
            wrap.className = 'bubble bot';
            wrap.textContent = msg;
            const actions = document.createElement('div');
            actions.style.marginTop = '8px';
            const accept = document.createElement('button'); accept.textContent = 'Accept'; accept.style.marginRight = '8px';
            const reject = document.createElement('button'); reject.textContent = 'Reject'; reject.className = 'secondary';
            actions.appendChild(accept); actions.appendChild(reject); wrap.appendChild(actions);
            bot.replaceWith(wrap);
            function finalize(choice){
              try{ accept.disabled = true; reject.disabled = true; actions.remove(); }catch{}
              agentPromptEl.value = choice;
              runAgentBtn.click();
            }
            accept.onclick = ()=> finalize('Yes');
            reject.onclick = ()=> finalize('No');
          } else {
            bot.textContent = msg;
          }
          history.push({ role: 'assistant', content: msg });
          try { rememberAssistantMessage(msg); } catch {}
          // Refresh pricing data only if the agent actually mutated this order.
          // This protects any local, unsaved edits from being wiped by a reload when the agent declines or only asks a question.
          try { if (didMutateCurrentOrder(data)) { await load(); } } catch {}
        } catch (e) {
          bot.textContent = 'Error: ' + e;
        } finally {
          runAgentBtn.disabled = false;
          runAgentBtn.textContent = prevLabel;
        }
      });

      // Keyboard shortcuts: Enter submits, Shift+Enter inserts newline
      agentPromptEl.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){
          if (e.shiftKey) return; // newline
          e.preventDefault();
          if (!runAgentBtn.disabled) runAgentBtn.click();
        }
      });
    </script>
  </body>
  </html>



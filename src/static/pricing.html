<!doctype html>
<html data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <title>Pricing</title>
    <style>
      * { box-sizing: border-box; }
      :root { --bg:#f6f7fb; --surface:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; --accent-600:#1d4ed8; --accent-700:#1e40af; --table-header:#f1f5f9; --shadow-sm:0 1px 2px rgba(16,24,40,.06); --shadow-md:0 6px 14px rgba(16,24,40,.08); --prompt-text:#374151 }
      [data-theme="dark"] { --bg:#0b1220; --surface:#0f172a; --text:#e5e7eb; --muted:#97a3b6; --border:#1f2937; --accent:#22d3ee; --accent-600:#06b6d4; --accent-700:#0891b2; --table-header:#0b1220; --prompt-text:#cbd5e1 }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); margin:0; }
      .topbar { position: sticky; top: 0; z-index: 10; background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); }
      .topbar .inner { max-width: 1120px; margin: 0 auto; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
      .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px }
      .brand .dot { width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.15) }
      .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text); cursor:pointer; box-shadow:var(--shadow-sm) }
      .icon-btn:hover { background:rgba(0,0,0,.03) }
      .container{ max-width: 1120px; margin:0 auto; padding:24px; }
      .breadcrumbs { margin-bottom: 12px; }
      a { color:#2563eb; text-decoration:none; }
      .card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px; box-shadow: var(--shadow-md) }
      table { width:100%; border-collapse:collapse; font-size:14px; }
      th, td { border:1px solid var(--border); padding:8px 10px; }
      thead th { background:var(--table-header); text-align:left; }
      input[type="text"], input[type="number"] { 
        width:100%; padding:6px 8px; border:1px solid var(--border); border-radius:6px; color:var(--prompt-text); font-weight: 600;
      }
      .actions { display:flex; gap:10px; margin-top:12px; }
      button { padding:10px 14px; border-radius:8px; border:1px solid var(--accent); background:var(--accent); color:#fff; cursor:pointer; }
      button.secondary { background:#fff; color:var(--accent); }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="inner">
        <div class="brand"><span class="dot"></span> <span>CPQ Platform</span></div>
        <div class="top-actions">
          <button class="icon-btn" id="themeBtn" title="Toggle theme">üåì</button>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="breadcrumbs">
        <a href="/">‚Üê Back to CPQ</a> &nbsp;|&nbsp; <a href="/orders">Orders</a>
      </div>
      <div class="card">
        <h2>Pricing</h2>
        <div id="meta"></div>
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:50%">Item</th>
              <th style="width:12%">Quantity</th>
              <th style="width:18%">Unit Cost</th>
              <th style="width:20%">Line Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="actions">
          <button id="save">Save</button>
          <button id="cancel" class="secondary">Cancel</button>
        </div>
      </div>
    </div>
    <script>
      const orderId = location.pathname.split('/').pop();
      const tbody = document.querySelector('#tbl tbody');
      const meta = document.getElementById('meta');
      let original = null;

      function row(item){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" value="${item.item||''}" /></td>
          <td><input type="number" step="0.01" value="${Number(item.quantity||0)}" /></td>
          <td><input type="number" step="0.01" value="${Number(item.unit_cost||0)}" /></td>
          <td class="total">$${Number(item.line_total||0).toFixed(2)}</td>
        `;
        const [iName, iQty, iCost] = tr.querySelectorAll('input');
        function recalc(){
          const qty = parseFloat(iQty.value||'0')||0;
          const cost = parseFloat(iCost.value||'0')||0;
          tr.querySelector('.total').textContent = `$${(qty*cost).toFixed(2)}`;
        }
        iQty.addEventListener('input', recalc);
        iCost.addEventListener('input', recalc);
        return tr;
      }

      async function load(){
        const res = await fetch(`/pricing/data/${orderId}`);
        const data = await res.json();
        const o = data.order;
        original = JSON.parse(JSON.stringify(o));
        meta.textContent = `Order ${o.id} ‚Äî Source: ${o.source_file} ‚Äî Subtotal: $${Number(o.subtotal||0).toFixed(2)}`;
        tbody.innerHTML='';
        for(const it of (o.items||[])) tbody.appendChild(row(it));
      }

      document.getElementById('cancel').onclick = ()=>{ load(); };
      document.getElementById('save').onclick = async ()=>{
        const items=[];
        for(const tr of tbody.querySelectorAll('tr')){
          const [iName, iQty, iCost] = tr.querySelectorAll('input');
          items.push({ item:iName.value, quantity: parseFloat(iQty.value||'0')||0, unit_cost: parseFloat(iCost.value||'0')||0 });
        }
        const res = await fetch(`/pricing/save/${orderId}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items }) });
        const data = await res.json();
        if(data && data.ok){
          // Reload to show recomputed totals
          await load();
          alert('Saved');
        } else {
          alert('Save failed');
        }
      };

      load();
    </script>
  </body>
  </html>



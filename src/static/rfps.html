<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RFPs</title>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f6f7fb; color:#0f172a; margin:0; }
      .container{ max-width: 960px; margin:0 auto; padding:24px; }
      .tabs { display:flex; gap:10px; border-bottom:1px solid #e5e7eb; margin-bottom:20px; }
      .tab { padding:10px 12px; color:#6b7280; text-decoration:none; border:1px solid transparent; border-top-left-radius:8px; border-top-right-radius:8px; }
      .tab.active { color:#0f172a; background:#fff; border-color:#e5e7eb #e5e7eb #fff; }
      .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; }
      .row { margin-bottom: 14px; }
      label { display:block; font-size:13px; color:#6b7280; margin-bottom:6px; }
      textarea, input[type="file"] { width:100%; background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:10px 12px; font-size:14px; color:#0f172a; }
      input[type="file"] { height: 40px; padding:6px 10px; }
      input[type="file"]::file-selector-button { border:none; background:#2563eb; color:#fff; border-radius:6px; padding:8px 12px; margin-right:12px; cursor:pointer; }
      input[type="file"]::-webkit-file-upload-button { border:none; background:#2563eb; color:#fff; border-radius:6px; padding:8px 12px; margin-right:12px; cursor:pointer; }
      button { appearance:none; border:1px solid #2563eb; background:#2563eb; color:#fff; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; }
      pre { background:#fafafa; border:1px solid #e5e7eb; border-radius:8px; padding:12px; font-size:12px; line-height:1.45; max-height:280px; overflow:auto; }
      table { width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
      th, td { border:1px solid #e5e7eb; padding:8px 10px; }
      thead th { background:#f1f5f9; text-align:left; }
    </style>
  </head>
  <body>
    <div class="container">
      <nav class="tabs">
        <a class="tab" href="/agent">Home</a>
        <a class="tab" href="/">CPQ</a>
        <a class="tab active" href="/rfps">RFP's</a>
        <a class="tab" href="/orders">Orders</a>
        <a class="tab" href="/logs">Logs</a>
      </nav>
      <div class="card">
        <h2>RFP Upload</h2>
        <form id="uploadForm">
          <div class="row">
            <label for="file">Select PDF or DOCX</label>
            <input type="file" id="file" accept=".pdf,.docx" required />
          </div>
          <div class="row">
            <button type="submit">Upload & Ingest</button>
          </div>
        </form>
        <h3>Ingest Result</h3>
        <div id="tableWrap"></div>
        <pre id="ingestResult">(no result yet)</pre>
        <button id="openPdf" style="display:none">Open PDF Preview</button>
      </div>
    </div>
    <script>
      const uploadForm = document.getElementById('uploadForm');
      const fileEl = document.getElementById('file');
      const ingestResultEl = document.getElementById('ingestResult');
      const tableWrap = document.getElementById('tableWrap');
      const openPdfBtn = document.getElementById('openPdf');

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        ingestResultEl.textContent = 'Uploading...';
        try {
          const fd = new FormData();
          if (!fileEl.files.length) {
            ingestResultEl.textContent = 'Please select a file';
            return;
          }
          fd.append('file', fileEl.files[0]);
          const res = await fetch('/agent/upload', { method: 'POST', body: fd });
          const data = await res.json();
          ingestResultEl.textContent = JSON.stringify(data, null, 2);
          if (data && Array.isArray(data.items) && data.items.length) {
            const tbl = document.createElement('table');
            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th>Item</th><th style="text-align:right">Quantity</th><th style="text-align:right">Unit Cost</th><th style="text-align:right">Line Total</th></tr>';
            tbl.appendChild(thead);
            const tbody = document.createElement('tbody');
            for (const it of data.items) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${(it.item||'')}</td>
                <td style="text-align:right">${Number(it.quantity||0)}</td>
                <td style="text-align:right">$${Number(it.unit_cost||0).toFixed(2)}</td>
                <td style="text-align:right">$${Number(it.line_total||0).toFixed(2)}</td>
              `;
              tbody.appendChild(tr);
            }
            const trSub = document.createElement('tr');
            trSub.innerHTML = `
              <td colspan="3" style="text-align:right;font-weight:700">Subtotal</td>
              <td style="text-align:right;font-weight:700">$${Number(data.subtotal||0).toFixed(2)}</td>
            `;
            tbody.appendChild(trSub);
            tbl.appendChild(tbody);
            tableWrap.innerHTML = '';
            tableWrap.appendChild(tbl);

            openPdfBtn.style.display = 'inline-block';
            openPdfBtn.onclick = async () => {
              const pdfRes = await fetch('/agent/quote_pdf', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: data.items, subtotal: data.subtotal })
              });
              const blob = await pdfRes.blob();
              const url = URL.createObjectURL(blob);
              window.open(url, '_blank');
            };
          } else {
            tableWrap.innerHTML = '';
            openPdfBtn.style.display = 'none';
          }
        } catch (e) {
          ingestResultEl.textContent = 'Error: ' + e;
        }
      });
    </script>
    </div>
  </body>
  </html>



<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RFPs</title>
    <style>
      * { box-sizing: border-box; }
      :root { --bg:#f6f7fb; --surface:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; --accent-600:#1d4ed8; --accent-700:#1e40af; --table-header:#f1f5f9; --shadow-sm:0 1px 2px rgba(16,24,40,.06); --shadow-md:0 6px 14px rgba(16,24,40,.08); --prompt-text:#374151 }
      [data-theme="dark"] { --bg:#0b1220; --surface:#0f172a; --text:#e5e7eb; --muted:#97a3b6; --border:#1f2937; --accent:#22d3ee; --accent-600:#06b6d4; --accent-700:#0891b2; --table-header:#0b1220; --prompt-text:#cbd5e1 }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); margin:0; }
      .topbar { position: sticky; top: 0; z-index: 10; background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); }
      .topbar .inner { max-width: 1120px; margin: 0 auto; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
      .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px }
      .brand .dot { width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.15) }
      .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text); cursor:pointer; box-shadow:var(--shadow-sm) }
      .icon-btn:hover { background:rgba(0,0,0,.03) }
      .container{ max-width: 1120px; margin:0 auto; padding:24px; }
      .tabs { display:flex; gap:10px; border-bottom:1px solid #e5e7eb; margin-bottom:20px; }
      .tab { padding:10px 12px; color:#6b7280; text-decoration:none; border:1px solid transparent; border-top-left-radius:8px; border-top-right-radius:8px; }
      .tab.active { color:#0f172a; background:#fff; border-color:#e5e7eb #e5e7eb #fff; }
      .card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px; box-shadow: var(--shadow-md) }
      .two-col { display:grid; grid-template-columns: 1fr .8fr; gap:24px; }
      .sticky { position: sticky; top: 16px; }
      .row { margin-bottom: 14px; }
      label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
      textarea, input[type="file"] { width:100%; background:#fff; border:1px solid var(--border); border-radius:8px; padding:10px 12px; font-size:14px; color:var(--prompt-text); }
      input[type="file"] { height: 40px; padding:6px 10px; }
      input[type="file"]::file-selector-button { border:none; background:var(--accent); color:#fff; border-radius:6px; padding:8px 12px; margin-right:12px; cursor:pointer; }
      input[type="file"]::-webkit-file-upload-button { border:none; background:var(--accent); color:#fff; border-radius:6px; padding:8px 12px; margin-right:12px; cursor:pointer; }
      button { appearance:none; border:1px solid var(--accent); background:var(--accent); color:#fff; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; }
      pre { background:#fafafa; border:1px solid var(--border); border-radius:8px; padding:12px; font-size:12px; line-height:1.45; max-height:280px; overflow:auto; }
      table { width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
      th, td { border:1px solid var(--border); padding:8px 10px; }
      thead th { background:var(--table-header); text-align:left; }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="inner">
        <div class="brand"><span class="dot"></span> <span>CPQ Platform</span></div>
        <div class="top-actions">
          <button class="icon-btn" id="themeBtn" title="Toggle theme">ðŸŒ“</button>
        </div>
      </div>
    </div>
    <div class="container">
      <nav class="tabs">
        <a class="tab" href="/agent">Home</a>
        <a class="tab" href="/">CPQ</a>
        <a class="tab active" href="/rfps">RFP's</a>
        <a class="tab" href="/orders">Orders</a>
        <a class="tab" href="/logs">Logs</a>
      </nav>
      <div class="two-col">
        <div class="card">
          <h2>RFP Upload</h2>
          <form id="uploadForm">
          <div class="row">
            <label for="file">Select PDF or DOCX</label>
            <input type="file" id="file" accept=".pdf,.docx" required />
          </div>
          <div class="row">
            <button type="submit">Upload & Ingest</button>
          </div>
          </form>
          <h3>Ingest Result</h3>
          <div id="tableWrap"></div>
          <pre id="ingestResult">(no result yet)</pre>
          <button id="openPdf" style="display:none">Open PDF Preview</button>
        </div>
        <div class="card sticky">
          <h2>Run Agent</h2>
          <div class="row">
            <label for="prompt">Prompt</label>
            <textarea id="prompt" style="width:100%;height:120px">Say hello and list the available MCP tools.</textarea>
          </div>
          <div class="row">
            <button id="run">Run Agent</button>
          </div>
          <h3>Result</h3>
          <pre id="result">(no result yet)</pre>
        </div>
      </div>
    </div>
    <script>
      const uploadForm = document.getElementById('uploadForm');
      const fileEl = document.getElementById('file');
      const ingestResultEl = document.getElementById('ingestResult');
      const tableWrap = document.getElementById('tableWrap');
      const openPdfBtn = document.getElementById('openPdf');

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        ingestResultEl.textContent = 'Uploading...';
        try {
          const fd = new FormData();
          if (!fileEl.files.length) {
            ingestResultEl.textContent = 'Please select a file';
            return;
          }
          fd.append('file', fileEl.files[0]);
          const res = await fetch('/agent/upload', { method: 'POST', body: fd });
          const data = await res.json();
          ingestResultEl.textContent = JSON.stringify(data, null, 2);
          if (data && Array.isArray(data.items) && data.items.length) {
            const tbl = document.createElement('table');
            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th>Item</th><th style="text-align:right">Quantity</th><th style="text-align:right">Unit Cost</th><th style="text-align:right">Line Total</th></tr>';
            tbl.appendChild(thead);
            const tbody = document.createElement('tbody');
            for (const it of data.items) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${(it.item||'')}</td>
                <td style="text-align:right">${Number(it.quantity||0)}</td>
                <td style="text-align:right">$${Number(it.unit_cost||0).toFixed(2)}</td>
                <td style="text-align:right">$${Number(it.line_total||0).toFixed(2)}</td>
              `;
              tbody.appendChild(tr);
            }
            const trSub = document.createElement('tr');
            trSub.innerHTML = `
              <td colspan="3" style="text-align:right;font-weight:700">Subtotal</td>
              <td style="text-align:right;font-weight:700">$${Number(data.subtotal||0).toFixed(2)}</td>
            `;
            tbody.appendChild(trSub);
            tbl.appendChild(tbody);
            tableWrap.innerHTML = '';
            tableWrap.appendChild(tbl);

            openPdfBtn.style.display = 'inline-block';
            openPdfBtn.onclick = async () => {
              const pdfRes = await fetch('/agent/quote_pdf', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: data.items, subtotal: data.subtotal })
              });
              const blob = await pdfRes.blob();
              const url = URL.createObjectURL(blob);
              window.open(url, '_blank');
            };
          } else {
            tableWrap.innerHTML = '';
            openPdfBtn.style.display = 'none';
          }
        } catch (e) {
          ingestResultEl.textContent = 'Error: ' + e;
        }
      });
    </script>
    <script>
      function safeParseJSON(str){
        if (typeof str !== 'string') return null;
        try { return JSON.parse(str); } catch { return null; }
      }
      function toHumanReadable(data){
        let payload = data;
        if (payload && Object.prototype.hasOwnProperty.call(payload, 'result')){
          const inner = typeof payload.result === 'string' ? (safeParseJSON(payload.result) || payload.result) : payload.result;
          payload = inner;
        }
        if (typeof payload === 'string') return payload;
        if (payload && typeof payload === 'object'){
          const lines = [];
          const updated = Array.isArray(payload.updated_ids) ? payload.updated_ids : [];
          const createdId = payload.created_id || (payload.order && payload.order.id);
          if (updated.length) lines.push(`Updated ${updated.length} order(s): ${updated.join(', ')}.`);
          if (createdId) lines.push(`Created order ${createdId}.`);
          if (Array.isArray(payload.orders) && payload.orders.length){
            const list = payload.orders.map(o=>`${o.id} ($${Number(o.subtotal||0).toFixed(2)}; ${o.status||'n/a'})`).join('; ');
            lines.push(`Selected orders: ${list}.`);
          }
          if (payload.notes) lines.push(String(payload.notes).endsWith('.') ? payload.notes : payload.notes + '.');
          if (payload.message && !lines.length) lines.push(String(payload.message));
          return lines.length ? lines.join(' ') : JSON.stringify(data, null, 2);
        }
        return JSON.stringify(data, null, 2);
      }
      const runBtn = document.getElementById('run');
      const promptEl = document.getElementById('prompt');
      const resultEl = document.getElementById('result');
      runBtn.addEventListener('click', async () => {
        resultEl.textContent = 'Running...';
        try {
          const res = await fetch('/agent/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: promptEl.value })
          });
          const data = await res.json();
          resultEl.textContent = toHumanReadable(data);
        } catch (e) {
          resultEl.textContent = 'Error: ' + e;
        }
      });
    </script>
  </body>
  </html>



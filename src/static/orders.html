<!doctype html>
<html data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <title>Orders</title>
    <style>
      * { box-sizing: border-box; }
      :root { --bg:#f6f7fb; --surface:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; --accent-600:#1d4ed8; --accent-700:#1e40af; --table-header:#f1f5f9; --shadow-sm:0 1px 2px rgba(16,24,40,.06); --shadow-md:0 6px 14px rgba(16,24,40,.08); --prompt-text:#000000 }
      [data-theme="dark"] { --bg:#0b1220; --surface:#0f172a; --text:#e5e7eb; --muted:#97a3b6; --border:#1f2937; --accent:#22d3ee; --accent-600:#06b6d4; --accent-700:#0891b2; --table-header:#0b1220; --shadow-sm:0 1px 2px rgba(16,24,40,.06); --shadow-md:0 6px 14px rgba(16,24,40,.08); --prompt-text:#000000 }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); margin:0; }
      .topbar { position: sticky; top: 0; z-index: 10; background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); }
      .topbar .inner { max-width: 1120px; margin: 0 auto; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
      .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px }
      .brand .dot { width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.15) }
      .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text); cursor:pointer; box-shadow:var(--shadow-sm) }
      .icon-btn:hover { background:rgba(0,0,0,.03) }
      .container{ max-width: 1120px; margin:0 auto; padding:24px; }
      .tabs { display:flex; gap:10px; border-bottom:1px solid var(--border); margin-bottom:20px; }
      .tab { padding:10px 12px; color:var(--muted); text-decoration:none; border:1px solid transparent; border-top-left-radius:8px; border-top-right-radius:8px; }
      .tab.active { color:var(--text); background:var(--surface); border-color:var(--border) var(--border) #fff; }
      .card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px; box-shadow:var(--shadow-md) }
      .two-col { display:grid; grid-template-columns: 1fr .8fr; gap:24px; }
      .sticky { position: sticky; top: 16px; }
      table { width:100%; border-collapse:collapse; font-size:14px; }
      th, td { border:1px solid var(--border); padding:8px 10px; }
      thead th { background:var(--table-header); text-align:left; }
      select { padding:6px 8px; border:1px solid var(--border); border-radius:6px; }
      /* Match Run Agent button style with CPQ/Home */
      button { appearance:none; border:1px solid var(--accent); background:var(--accent); color:#fff; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; transition: background .15s ease, border-color .15s ease; }
      button:hover { background: var(--accent-600); border-color: var(--accent-600); }
      button:active { background: var(--accent-700); border-color: var(--accent-700); }
      textarea {
        width:100%; height:120px; background:#fff; border:1px solid var(--border); border-radius:8px; padding:10px 12px; color:var(--prompt-text); font-weight:400; font-family:inherit; font-size:16px;
      }
      pre {
        background:#fafafa; border:1px solid var(--border); border-radius:8px; padding:12px; font-size:16px; line-height:1.45; max-height:280px; overflow:auto; width:100%; color:var(--prompt-text); font-weight: 400; font-family: inherit;
      }
      /* Align Orders Run Agent UI with CPQ */
      .chat { display:flex; flex-direction:column; gap:8px; }
      .chat-scroll { max-height:340px; overflow:auto; }
      .bubble { max-width:80%; padding:10px 12px; border-radius:14px; box-shadow: var(--shadow-sm); font-weight:400; }
      .bubble.user { margin-left:auto; background:#e0e7ff; color:#1e1b4b; }
      .bubble.bot { margin-right:auto; background:#f1f5f9; color: var(--prompt-text); }
      .thinking { width:36px; height:12px; display:inline-flex; align-items:center; justify-content:space-between; }
      .thinking span { width:6px; height:6px; background: var(--muted); border-radius:999px; display:inline-block; animation: bounce 1.2s infinite ease-in-out; }
      .thinking span:nth-child(2){ animation-delay:.15s; }
      .thinking span:nth-child(3){ animation-delay:.3s; }
      @keyframes bounce { 0%,80%,100% { transform: translateY(0); opacity:.5 } 40% { transform: translateY(-6px); opacity:1 } }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="inner">
        <div class="brand"><span class="dot"></span> <span>Wilson App</span></div>
        <div class="top-actions"></div>
      </div>
    </div>
    <div class="container">
      <nav class="tabs">
        <a class="tab" href="/">Home</a>
        <a class="tab" href="/notetaker">Notetaker</a>
        <a class="tab" href="/cpq">CPQ</a>
        <a class="tab active" href="/orders">Orders</a>
        <a class="tab" href="/logs">Logs</a>
      </nav>
      <div class="two-col">
        <div class="card">
          <h2>Orders</h2>
          <table id="ordersTbl">
          <thead>
            <tr>
              <th>ID</th>
              <th>Quote PDF</th>
              <th>Items</th>
              <th>Customers</th>
              <th>Subtotal</th>
              <th>Status</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
          </table>
        </div>
        <div class="card sticky">
          <h2>Run Agent</h2>
          <div id="chat" class="chat chat-scroll" style="font-size:16px;color:var(--prompt-text);font-weight:400;font-family:inherit"></div>
          <div class="row" style="margin-top:12px">
            <label for="prompt">Prompt</label>
            <textarea id="prompt" style="width:100%;height:120px">Say hello!</textarea>
          </div>
          <div class="row">
            <button id="run">Run Agent</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      function safeParseJSON(str){
        if (typeof str !== 'string') return null;
        try { return JSON.parse(str); } catch { return null; }
      }
      function sanitizeAgentText(text){
        try{
          let s = String(text || '');
          s = s.replace(/\n?\s*-\s*\*\*[^*]+\*\*:\s*.*(?=\n|$)/g, '');
          s = s.replace(/```[\s\S]*?```/g, '');
          s = s.replace(/^[\t ]*[\[{].*$/gm, '');
          s = s.replace(/^[\t ]{0,3}#{1,6}[^\S\r\n]*(.*)$/gm, '$1');
          // Remove generic bullet/numbered list lines to avoid long item dumps
          s = s.replace(/^\s*(?:[-*]|\d+[.)])\s.*$/gm, '');
          // Remove boilerplate lead-ins like "Here are the details:" or "Here is a summary:" or "Details:"
          s = s.replace(/\bhere\s+(?:are|is)\s+the\s+details:\s*/gi, '');
          s = s.replace(/\bhere(?:â€™|'|\s+is)\s+a\s+summary:\s*/gi, '');
          s = s.replace(/(^|\n)\s*details:\s*/gi, '$1');
          s = s.split(/\n-\s\*\*/)[0];
          s = s.replace(/\*\*(.*?)\*\*/g, '$1');
          s = s.replace(/\n{2,}/g, '\n').trim();
          const sentence = s.match(/^.*?[.!?](?:\s|$)/);
          if (sentence && sentence[0]) s = sentence[0].trim();
          return s || String(text || '');
        }catch{return String(text||'');}
      }
      function extractAgentResult(payload){
        if (payload && Object.prototype.hasOwnProperty.call(payload, 'result')){
          return typeof payload.result === 'string' ? (safeParseJSON(payload.result) || {}) : (payload.result || {});
        }
        return payload || {};
      }
      function rememberAssistantMessage(msg){
        try{ fetch('/logs/emit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type:'assistant_message', details:{ message: msg } }) }); }catch{}
      }
      function toHumanReadable(data){
        let payload = data;
        if (payload && Object.prototype.hasOwnProperty.call(payload, 'result')){
          const inner = typeof payload.result === 'string' ? (safeParseJSON(payload.result) || payload.result) : payload.result;
          payload = inner;
        }
        if (typeof payload === 'string'){
          // Try to summarize multiple created orders succinctly
          try{
            const custs = [];
            const ids = [];
            const re = /Order for\s+([^()\n]+)\s*\(Order ID:\s*(OD-\d{5})\)/gi;
            let m; const txt = String(payload);
            while((m = re.exec(txt))){ custs.push(m[1].trim()); ids.push(m[2]); }
            if (ids.length){
              return `Created ${ids.length} order(s): ` + ids.map((id,i)=>`${id}${custs[i]?` (${custs[i]})`:''}`).join(', ') + '.';
            }
          }catch{}
          return sanitizeAgentText(payload);
        }
        if (payload && typeof payload === 'object'){
          const lines = [];
          // If a single order dict is returned (e.g., after status/customer update), emit a concise confirmation
          const singleOrder = (payload.order && payload.order.id) ? payload.order : ((payload.id && payload.status) ? payload : null);
          if (singleOrder && singleOrder.id && singleOrder.status){
            lines.push(`Updated ${singleOrder.id} to ${singleOrder.status}.`);
          }
          const updated = Array.isArray(payload.updated_ids) ? payload.updated_ids : [];
          const createdId = payload.created_id || (payload.order && payload.order.id);
          if (updated.length) lines.push(`Updated ${updated.length} order(s).`);
          if (createdId) lines.push(`Created order.`);
          if (Array.isArray(payload.orders) && payload.orders.length){
            lines.push(`Selected ${payload.orders.length} order(s).`);
          }
          if (payload.notes) lines.push(String(payload.notes).endsWith('.') ? payload.notes : payload.notes + '.');
          if (payload.message && !lines.length) lines.push(String(payload.message));
          return lines.length ? lines.join(' ') : 'Done.';
        }
        return 'Done.';
      }
      async function loadOrders(){
        const res = await fetch('/orders/data');
        const data = await res.json();
        const tbody = document.querySelector('#ordersTbl tbody');
        tbody.innerHTML='';
        for(const o of (data.orders||[])){
          const tr = document.createElement('tr');
          const sel = document.createElement('select');
          for(const s of ['Quoted','Sent','Received']){
            const opt = document.createElement('option');
            opt.value=s; opt.textContent=s; if(o.status===s) opt.selected=true; sel.appendChild(opt);
          }
          sel.onchange = async ()=>{
            await fetch('/orders/status', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:o.id, status:sel.value})});
          };
          const pdfLink = `<a href="/orders/pdf/${o.id}" target="_blank">Open</a>`;
          // Format created_at in US Eastern Time
          function formatET(iso){
            try{
              if (!iso) return '';
              const d = new Date(iso);
              const fmt = new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/New_York',
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
              }).format(d);
              return `${fmt} ET`;
            }catch{ return iso||''; }
          }
          const createdAt = o.created_at || '';
          const createdAtET = formatET(createdAt);
          tr.innerHTML = `
            <td><a href="/pricing/${o.id}">${o.id}</a></td>
            <td>${pdfLink}</td>
            <td>${o.items_count}</td>
            <td>${o.customer || ''}</td>
            <td>$${Number(o.subtotal||0).toLocaleString('en-US', {maximumFractionDigits:0, minimumFractionDigits:0})}</td>
            <td></td>
            <td title="${createdAt}">${createdAtET}</td>
          `;
          // Status column is index 5
          tr.children[5].appendChild(sel);
          tbody.appendChild(tr);
        }
      }
      loadOrders();

      const runBtn = document.getElementById('run');
      const promptEl = document.getElementById('prompt');
      const chatEl = document.getElementById('chat');
      function scrollChatToBottom(){ try{ chatEl.scrollTop = chatEl.scrollHeight; }catch{} }
      let history = [];
      runBtn.addEventListener('click', async () => {
        const text = promptEl.value;
        const user = document.createElement('div'); user.className='bubble user'; user.textContent = text; chatEl.appendChild(user); scrollChatToBottom();
        history.push({ role: 'user', content: text });
        promptEl.value = '';
        const bot = document.createElement('div'); bot.className='bubble bot'; bot.innerHTML = '<span class="thinking"><span></span><span></span><span></span></span>'; chatEl.appendChild(bot); scrollChatToBottom();
        try {
          const res = await fetch('/agent/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: text, history })
          });
          const data = await res.json();
          const msg = toHumanReadable(data);
          // If the assistant message asks a yes/no style clarification, render inline Accept/Reject buttons
          const lower = String(msg||'').toLowerCase();
          const looksYN = /\bproceed\b|\byes or no\b|\bconfirm\b/.test(lower);
          if (looksYN){
            const wrap = document.createElement('div');
            wrap.className = 'bubble bot';
            wrap.textContent = msg;
            const actions = document.createElement('div');
            actions.style.marginTop = '8px';
            const accept = document.createElement('button'); accept.textContent = 'Accept'; accept.style.marginRight = '8px';
            const reject = document.createElement('button'); reject.textContent = 'Reject'; reject.className = 'secondary';
            actions.appendChild(accept); actions.appendChild(reject); wrap.appendChild(actions);
            bot.replaceWith(wrap);
            try{ chatEl.scrollTop = chatEl.scrollHeight; }catch{}
            function finalize(choice){
              try{ accept.disabled = true; reject.disabled = true; actions.remove(); }catch{}
              // Set the prompt box so the next run captures and displays the user's choice
              promptEl.value = choice;
              runBtn.click();
            }
            accept.onclick = ()=> finalize('yes');
            reject.onclick = ()=> finalize('no');
          } else {
            bot.textContent = msg;
            try{ chatEl.scrollTop = chatEl.scrollHeight; }catch{}
          }
          history.push({ role: 'assistant', content: msg });
          // Persist the assistant message so backend can include it with short confirmations
          try { rememberAssistantMessage(msg); } catch {}
          // Refresh if the agent likely mutated orders (handles structured and plain-text responses)
          try {
            const r = extractAgentResult(data);
            let shouldRefresh = false;
            if (r && ((Array.isArray(r.updated_ids) && r.updated_ids.length) || r.order)) shouldRefresh = true;
            if (!shouldRefresh){
              const s1 = (typeof data === 'string') ? data : '';
              const s2 = (data && typeof data.result === 'string') ? data.result : '';
              const s = (s1 + ' ' + s2).toLowerCase();
              if (/\b(updated|changed|created|added|deleted|status|customer)\b/.test(s)) shouldRefresh = true;
            }
            if (shouldRefresh) await loadOrders();
          } catch {}
        } catch (e) {
          bot.textContent = 'Error: ' + e;
        }
      });

      // Keyboard shortcuts: Enter submits, Shift+Enter inserts newline
      promptEl.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){
          if (e.shiftKey) return; // insert newline
          e.preventDefault();
          if (!runBtn.disabled) runBtn.click();
        }
      });
    </script>
  </body>
  </html>



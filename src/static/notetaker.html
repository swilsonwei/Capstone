<!doctype html>
<html data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <title>Notetaker</title>
    <style>
      * { box-sizing: border-box; }
      :root { --bg:#f6f7fb; --surface:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; --accent-600:#1d4ed8; --accent-700:#1e40af; --table-header:#f1f5f9; --shadow-sm:0 1px 2px rgba(16,24,40,.06); --shadow-md:0 6px 14px rgba(16,24,40,.08); --prompt-text:#000000 }
      [data-theme="dark"] { --bg:#0b1220; --surface:#0f172a; --text:#e5e7eb; --muted:#97a3b6; --border:#1f2937; --accent:#22d3ee; --accent-600:#06b6d4; --accent-700:#0891b2; --table-header:#0b1220; --prompt-text:#000000 }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); margin:0; }
      .topbar { position: sticky; top: 0; z-index: 10; background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); }
      .topbar .inner { max-width: 1120px; margin: 0 auto; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
      .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px }
      .brand .dot { width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.15) }
      .container{ max-width: 1120px; margin:0 auto; padding:24px; }
      .tabs { display:flex; gap:10px; border-bottom:1px solid var(--border); margin-bottom:20px; }
      .tab { padding:10px 12px; color:var(--muted); text-decoration:none; border:1px solid transparent; border-top-left-radius:8px; border-top-right-radius:8px; }
      .tab.active { color:var(--text); background:var(--surface); border-color:var(--border) var(--border) #fff; }
      .card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px; box-shadow: var(--shadow-md) }
      textarea { width:100%; height: 220px; border:1px solid var(--border); border-radius:10px; padding:12px; font-size:16px; color:var(--prompt-text); font-family: inherit; }
      .actions { display:flex; gap:10px; margin-top:12px; }
      button { padding:10px 14px; border-radius:8px; border:1px solid var(--accent); background:var(--accent); color:#fff; cursor:pointer; }
      button:disabled { background:#9ca3af; border-color:#9ca3af; cursor:not-allowed; }
      .toasts { position: fixed; right: 16px; top: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
      .toast { background: var(--surface); color: var(--text); border: 1px solid var(--border); box-shadow: var(--shadow-md); border-radius: 10px; padding: 10px 12px; min-width: 220px; }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="inner">
        <div class="brand"><span class="dot"></span> <span>CPQ Platform</span></div>
        <div class="top-actions"></div>
      </div>
    </div>
    <div class="container">
      <nav class="tabs">
        <a class="tab" href="/">Home</a>
        <a class="tab active" href="/notetaker">Notetaker</a>
        <a class="tab" href="/cpq">CPQ</a>
        <a class="tab" href="/orders">Orders</a>
        <a class="tab" href="/logs">Logs</a>
      </nav>
      <div class="card">
        <h2>Call Notes</h2>
        <label for="notes" style="display:block;color:var(--muted);font-size:13px;margin-bottom:6px">Describe the call details. Notes will be used to draft a quote.</label>
        <textarea id="notes" placeholder="Ex: Customer wants a replica of OD-00012 with weekend surcharge $500 and service fee $1500."></textarea>
        <div class="actions">
          <button id="saveNotes">Save</button>
        </div>
      </div>
    </div>
    <div class="toasts" id="toasts"></div>
    <script>
      function showToast(msg){
        const box = document.getElementById('toasts');
        const t = document.createElement('div'); t.className='toast'; t.textContent=msg; box.appendChild(t);
        setTimeout(()=>t.remove(), 2400);
      }

      async function createOrderFromNotes(notes){
        try{
          const res = await fetch('/agent/run', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ prompt: notes })
          });
          const data = await res.json();
          const res2 = await fetch('/orders/data');
          const data2 = await res2.json();
          const orders = data2.orders || [];
          const newest = orders.length ? orders[0] : null;
          if(newest && newest.id){ return newest.id; }
          return null;
        } catch(e){ return null; }
      }

      const saveBtn = document.getElementById('saveNotes');
      saveBtn.onclick = async ()=>{
        const notes = document.getElementById('notes').value.trim();
        if(!notes){ showToast('Please enter some notes'); return; }
        saveBtn.disabled = true; const originalText = saveBtn.textContent; saveBtn.textContent = 'Saving...';
        showToast('Processing notes...');
        try{
          await fetch('/logs/emit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type:'notetaker_saved', details:{ length: notes.length }, prompt: notes }) });
        }catch{}
        const orderId = await createOrderFromNotes(notes);
        if(orderId){ location.href = `/pricing/${orderId}`; }
        else { showToast('Failed to create order'); saveBtn.disabled = false; saveBtn.textContent = originalText; }
      };
    </script>
  </body>
  </html>

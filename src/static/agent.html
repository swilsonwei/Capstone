<!doctype html>
<html data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <title>Home</title>
    <style>
      * { box-sizing: border-box; }
      :root {
        --bg: #f6f7fb;
        --surface: #ffffff;
        --text: #0f172a;
        --muted: #6b7280;
        --border: #e5e7eb;
        --accent: #2563eb;
        --accent-600: #1d4ed8;
        --accent-700: #1e40af;
        --table-header: #f1f5f9;
        --shadow-sm: 0 1px 2px rgba(16,24,40,.06);
        --shadow-md: 0 6px 14px rgba(16,24,40,.08);
        --prompt-text: #000000;
      }
      [data-theme="dark"] {
        --bg: #0b1220; --surface: #0f172a; --text: #e5e7eb; --muted: #97a3b6; --border: #1f2937;
        --accent: #22d3ee; --accent-600: #06b6d4; --accent-700: #0891b2; --table-header: #0b1220; --prompt-text:#000000;
      }
      html, body { height: 100%; }
      body { margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; }
      .topbar { position: sticky; top: 0; z-index: 10; background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: var(--shadow-sm); }
      .topbar .inner { max-width: 1120px; margin: 0 auto; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
      .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; }
      .brand .dot { width: 10px; height: 10px; border-radius: 999px; background: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
      .top-actions { display: flex; align-items: center; gap: 10px; }
      .icon-btn { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--text); cursor: pointer; box-shadow: var(--shadow-sm); }
      .icon-btn:hover { background: rgba(0,0,0,.03); }
      .icon-btn:active { transform: translateY(1px); }
      .container { max-width: 1120px; margin: 0 auto; padding: 24px; }
      .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
      .tab { padding: 10px 12px; border: 1px solid transparent; border-top-left-radius: 8px; border-top-right-radius: 8px; color: var(--muted); text-decoration: none; }
      .tab.active { color: var(--text); background: var(--surface); border-color: var(--border) var(--border) #fff; }
      .two-col { display: grid; grid-template-columns: 1fr; gap: 24px; }
      @media (min-width: 960px) { .two-col { grid-template-columns: 1.4fr .8fr; } }
      .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; box-shadow: var(--shadow-md); }
      .sticky { position: sticky; top: 16px; }
      .row { margin-bottom: 14px; }
      label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
      textarea {
        width: 100%; height: 140px; resize: vertical; background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; font-size: 16px; color: var(--prompt-text); font-weight: 400; font-family: inherit;
      }
      button { appearance: none; border: 1px solid var(--accent); background: var(--accent); color: #fff; border-radius: 8px; padding: 10px 14px; font-weight: 600; cursor: pointer; transition: background .15s ease, border-color .15s ease; }
      button:hover { background: var(--accent-600); border-color: var(--accent-600); }
      button:active { background: var(--accent-700); border-color: var(--accent-700); }
      pre { background: #fafafa; border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-size: 12px; line-height: 1.45; max-height: 280px; overflow: auto; width: 100%; }
      .footer { margin-top: 28px; padding: 18px 0; border-top: 1px solid var(--border); color: var(--muted); font-size: 12px; text-align: center; }
      .toasts { position: fixed; right: 16px; top: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
      .toast { background: var(--surface); color: var(--text); border: 1px solid var(--border); box-shadow: var(--shadow-md); border-radius: 10px; padding: 10px 12px; min-width: 220px; }
      .chat { display: flex; flex-direction: column; gap: 8px; font-size: 16px; color: var(--prompt-text); font-weight: 400; font-family: inherit; }
      .chat-scroll { max-height: 340px; overflow: auto; }
      .bubble {
        max-width: 80%; padding: 10px 12px; border-radius: 14px; box-shadow: var(--shadow-sm); font-weight: 400;
      }
      .bubble.user { margin-left: auto; background: #e0e7ff; color: #1e1b4b; }
      .bubble.bot { margin-right: auto; background: #f1f5f9; }
      .thinking { width: 36px; height: 12px; display: inline-flex; align-items: center; justify-content: space-between; }
      .thinking span { width: 6px; height: 6px; background: var(--muted); border-radius: 999px; display: inline-block; animation: bounce 1.2s infinite ease-in-out; }
      .thinking span:nth-child(2){ animation-delay: .15s; }
      .thinking span:nth-child(3){ animation-delay: .3s; }
      @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); opacity: .5 } 40% { transform: translateY(-6px); opacity: 1 } }
      /* Status mini-cards */
      .stats-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
      @media (min-width: 720px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
      .stat-card { border: 1px solid var(--border); background: var(--surface); border-radius: 14px; padding: 14px; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
      .stat-card::before { content: ""; position: absolute; inset: 0; background: rgba(37,99,235,.06); opacity: .7; pointer-events:none; }
      .stat-card .inner { position: relative; }
      .stat-card .label { font-size: 12px; color: var(--muted); margin-bottom: 8px; letter-spacing: .2px; }
      .stat-card .value { font-size: 22px; font-weight: 800; color: var(--text); }
      .stat-card .sub { font-size: 12px; color: var(--muted); margin-top: 6px; }
      .stat-quoted { border-left: 4px solid var(--accent); }
      .stat-sent { border-left: 4px solid var(--accent-600); }
      .stat-received { border-left: 4px solid var(--accent-700); }
      /* Top customers grid */
      .customers-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 14px; }
      @media (min-width: 720px) { .customers-grid { grid-template-columns: repeat(3, 1fr); } }
      /* Reuse stat-card styling for top customers */
      .section-break { margin-top: 18px; }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="inner">
        <div class="brand"><span class="dot"></span> <span>Wilson App</span></div>
        <div class="top-actions"></div>
      </div>
    </div>
    <div class="container">
      <nav class="tabs">
        <a class="tab active" href="/">Home</a>
        <a class="tab" href="/notetaker">Notetaker</a>
        <a class="tab" href="/cpq">CPQ</a>
        <a class="tab" href="/orders">Orders</a>
        <a class="tab" href="/logs">Logs</a>
      </nav>
      <div class="two-col">
        <div class="card">
          <h2>Orders Dashboard</h2>
          <div class="row">Total Order Cost: <strong id="totCost">$0.00</strong></div>
          <div class="row">Open Orders: <strong id="openCnt">0</strong></div>
          <div class="stats-grid">
            <div class="stat-card stat-quoted"><div class="inner">
              <div class="label">Quoted</div>
              <div class="value" id="quotedCnt">0</div>
              <div class="sub">Total: <span id="quotedSum">$0</span></div>
            </div>
            </div>
            <div class="stat-card stat-sent"><div class="inner">
              <div class="label">Sent</div>
              <div class="value" id="sentCnt">0</div>
              <div class="sub">Total: <span id="sentSum">$0</span></div>
            </div>
            </div>
            <div class="stat-card stat-received"><div class="inner">
              <div class="label">Received</div>
              <div class="value" id="receivedCnt">0</div>
              <div class="sub">Total: <span id="receivedSum">$0</span></div>
            </div>
            </div>
          </div>
          <div class="row section-break">Top Customers</div>
          <div class="customers-grid" id="topCustomers"></div>
        </div>
        <div class="card sticky">
          <h2>Run Agent</h2>
          <div id="chat" class="chat chat-scroll" style="color:var(--prompt-text)"></div>
          <div class="row" style="margin-top:12px">
            <label for="prompt">Prompt</label>
            <textarea id="prompt">Say hello!</textarea>
          </div>
          <div class="row">
            <button id="run">Run Agent</button>
          </div>
        </div>
      </div>
      <div class="footer">© 2025 Wilson App</div>
    </div>
    <div class="toasts" id="toasts"></div>
    <script>
      const themeBtn = document.getElementById('themeBtn');
      const toasts = document.getElementById('toasts');
      const runBtn = document.getElementById('run');
      const promptEl = document.getElementById('prompt');
      const chatEl = document.getElementById('chat');
      let history = [];
      function showToast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; toasts.appendChild(t); setTimeout(()=>t.remove(), 2400); }
      if (themeBtn) themeBtn.onclick = ()=>{ const d=document.documentElement; d.setAttribute('data-theme', d.getAttribute('data-theme')==='dark'?'light':'dark'); showToast('Theme updated'); };
      function safeParseJSON(str){
        if (typeof str !== 'string') return null;
        try { return JSON.parse(str); } catch { return null; }
      }
      function sanitizeAgentText(text){
        try{
          let s = String(text || '');
          // Drop markdown bullet key/value details like: - **Label**: value
          s = s.replace(/\n?\s*-\s*\*\*[^*]+\*\*:\s*.*(?=\n|$)/g, '');
          // Remove fenced code blocks
          s = s.replace(/```[\s\S]*?```/g, '');
          // If there are inline JSON-ish blocks, remove lines starting with { or [
          s = s.replace(/^[\t ]*[\[{].*$/gm, '');
          // Strip markdown headings like #, ##, ### while keeping content
          s = s.replace(/^[\t ]{0,3}#{1,6}[^\S\r\n]*(.*)$/gm, '$1');
          // If the message includes a lead sentence followed by details on new bullet lines, keep only lead
          s = s.split(/\n-\s\*\*/)[0];
          // Strip any remaining bold markdown wrappers
          s = s.replace(/\*\*(.*?)\*\*/g, '$1');
          // Collapse extra whitespace
          s = s.replace(/\n{2,}/g, '\n').trim();
          // Keep only the first sentence for brevity
          const sentence = s.match(/^.*?[.!?](?:\s|$)/);
          if (sentence && sentence[0]) s = sentence[0].trim();
          return s || String(text || '');
        }catch{return String(text||'');}
      }
      function rememberAssistantMessage(msg){
        try{ fetch('/logs/emit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type:'assistant_message', details:{ message: msg } }) }); }catch{}
      }
      function toHumanReadable(data){
        let payload = data;
        if (payload && Object.prototype.hasOwnProperty.call(payload, 'result')){
          const inner = typeof payload.result === 'string' ? (safeParseJSON(payload.result) || payload.result) : payload.result;
          payload = inner;
        }
        if (typeof payload === 'string') return sanitizeAgentText(payload);
        if (payload && typeof payload === 'object'){
          const lines = [];
          const updated = Array.isArray(payload.updated_ids) ? payload.updated_ids : [];
          const createdId = payload.created_id || (payload.order && payload.order.id);
          if (updated.length) lines.push(`Updated ${updated.length} order(s).`);
          if (createdId) lines.push(`Created order.`);
          if (Array.isArray(payload.orders) && payload.orders.length){
            lines.push(`Selected ${payload.orders.length} order(s).`);
          }
          if (payload.notes) lines.push(String(payload.notes).endsWith('.') ? payload.notes : payload.notes + '.');
          if (payload.message && !lines.length) lines.push(String(payload.message));
          return lines.length ? lines.join(' ') : 'Done.';
        }
        return 'Done.';
      }
      runBtn.addEventListener('click', async () => {
        const text = promptEl.value;
        const user=document.createElement('div'); user.className='bubble user'; user.textContent=text; chatEl.appendChild(user);
        history.push({ role: 'user', content: text });
        promptEl.value = '';
        const bot=document.createElement('div'); bot.className='bubble bot'; bot.innerHTML='<span class="thinking"><span></span><span></span><span></span></span>'; chatEl.appendChild(bot);
        // Busy state
        const prev = runBtn.textContent;
        runBtn.disabled = true;
        runBtn.textContent = 'Running...';
        try {
          const res = await fetch('/agent/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: text, history })
          });
          const data = await res.json();
          const msg = toHumanReadable(data);
          bot.textContent = msg;
          history.push({ role: 'assistant', content: msg });
          try { rememberAssistantMessage(msg); } catch {}
          showToast('Agent completed');
          // Refresh dashboard stats so changes are visible immediately
          try { await loadStats(); } catch {}
        } catch (e) {
          bot.textContent = 'Error: ' + e;
        } finally {
          runBtn.disabled = false;
          runBtn.textContent = prev;
        }
      });

      async function loadStats(){
        try {
          const res = await fetch('/orders/stats');
          const data = await res.json();
          document.getElementById('totCost').textContent = `$${Number(data.total_cost||0).toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
          document.getElementById('openCnt').textContent = Number(data.open_count||0);
          // Fetch full orders to compute per-status aggregates
          const res2 = await fetch('/orders/data');
          const data2 = await res2.json();
          const orders = data2.orders || [];
          const agg = {Quoted:{c:0,s:0}, Sent:{c:0,s:0}, Received:{c:0,s:0}};
          for(const o of orders){
            const st = o.status||'Quoted';
            if(!agg[st]) agg[st] = {c:0,s:0};
            agg[st].c += 1;
            agg[st].s += Number(o.subtotal||0);
          }
          document.getElementById('quotedCnt').textContent = agg.Quoted.c;
          document.getElementById('quotedSum').textContent = `$${Number(agg.Quoted.s||0).toLocaleString('en-US', {maximumFractionDigits:0})}`;
          document.getElementById('sentCnt').textContent = agg.Sent.c;
          document.getElementById('sentSum').textContent = `$${Number(agg.Sent.s||0).toLocaleString('en-US', {maximumFractionDigits:0})}`;
          document.getElementById('receivedCnt').textContent = agg.Received.c;
          document.getElementById('receivedSum').textContent = `$${Number(agg.Received.s||0).toLocaleString('en-US', {maximumFractionDigits:0})}`;

          // Top 3 customers by total order volume
          const byCustomer = new Map();
          for (const o of orders){
            const cust = (o.customer||'').trim() || 'Unknown';
            const prev = byCustomer.get(cust) || { sum:0, count:0 };
            prev.sum += Number(o.subtotal||0);
            prev.count += 1;
            byCustomer.set(cust, prev);
          }
          const top = Array.from(byCustomer.entries())
            .sort((a,b)=> b[1].sum - a[1].sum)
            .slice(0,3);
          const wrap = document.getElementById('topCustomers');
          if (wrap){
            wrap.innerHTML = '';
            for (const [name, info] of top){
              const card = document.createElement('div');
              card.className = 'stat-card';
              card.innerHTML = `
                <div class="inner">
                  <div class="value">${name || 'Unknown'}</div>
                  <div class="sub">Total: $${Number(info.sum||0).toLocaleString('en-US', {maximumFractionDigits:0})} · Orders: ${info.count}</div>
                </div>`;
              wrap.appendChild(card);
            }
          }
        } catch {}
      }
      loadStats();
    </script>
  </body>
 </html>


